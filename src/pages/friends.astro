---
import { getEntry, render } from "astro:content";
import Markdown from "@components/misc/Markdown.astro";
import Icon from "../components/misc/Icon.astro";
import { siteConfig } from "../config";
import { getFriendsList, getShuffledFriendsList } from "../data/friends";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";

if (!siteConfig.featurePages.friends) return Astro.redirect("/404/");

const friendsPost = await getEntry("spec", "friends");
if (!friendsPost) throw new Error("friends page content not found");
const { Content } = await render(friendsPost);

/* 拉取友链数据 */
type FriendItem = {
  title:string; url:string; icon:string; snapshot:string;
  description:string; feed:string;
  posts:{title:string;link:string;published:string}[];
  issue_number:number;
  labels:{name:string;hue:number;saturation:number;lightness:number}[];
};
const remote = await fetch("https://friends-api.kemeow.top/v2/data.json")
                .then(r=>r.json() as Promise<{content:FriendItem[]}>)
                .catch(()=>({content:[]}));
const shuffle = <T,>(a:T[])=> a.sort(()=>Math.random()-0.5);
const friends = shuffle(remote.content);
---

<MainGridLayout title={i18n(I18nKey.friends)} description={i18n(I18nKey.friends)}>
  <div class="friends-container">
    <!-- 友链卡片 -->
    <div class="friends-grid">
      {friends.map(f=>(
        <div class="glass-card">
          <div class="card-header">
            <img src={f.icon} alt={f.title} class="avatar"/>
            <div class="info">
              <a class="title" href={f.url} target="_blank" rel="noopener noreferrer">{f.title}</a>
              <p class="desc">{f.description}</p>
              <div class="capsules">
                {f.labels.map(l=>(
                  <span class="capsule" style={`--h:${l.hue} ${l.saturation}% ${l.lightness}%`}>{l.name}</span>
                ))}
              </div>
            </div>
          </div>
          <div class="timeline">
            {f.posts.slice(0,3).map(p=>(
              <a class="timeline-item" href={p.link} target="_blank" rel="noopener noreferrer">
                <time>{p.published.split(' ')[0]}</time>
                <span>{p.title}</span>
              </a>
            ))}
          </div>
          <div class="actions">
            <a href={f.url} target="_blank" rel="noopener noreferrer" class="btn primary" aria-label="访问">
              <svg viewBox="0 0 24 24"><path fill="currentColor" d="M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6l-6 6l-1.41-1.41z"/></svg>
            </a>
            <a href={f.feed} target="_blank" rel="noopener noreferrer" class="btn" aria-label="RSS">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">
                <path fill="#ef4444" d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27zm0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93z"/>
              </svg>
            </a>
            <a href={f.snapshot} target="_blank" rel="noopener noreferrer" class="btn" aria-label="快照">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24">
                <g fill="none" stroke="#f59e0b" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                  <path d="M15 8h.01M3 6a3 3 0 0 1 3-3h12a3 3 0 0 1 3 3v12a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3z"/>
                  <path d="m3 16l5-5c.928-.893 2.072-.893 3 0l5 5"/>
                  <path d="m14 14l1-1c.928-.893 2.072-.893 3 0l3 3"/>
                </g>
              </svg>
            </a>
          </div>
        </div>
      ))}
    </div>

    <!-- 友链朋友圈 -->
<section class="fc-section">
  <h2 id="small-circle">友链朋友圈</h2>
     <div id='friend-circle-lite-root' class='not-prose'>加载更多</div>
   <script>
      import '@/assets/styles/fc.css'

      import { FriendCircle } from '@/plugins/friendCircle'

      const fc = new FriendCircle()
      fc.init({
         private_api_url: 'https://fc.kemeow.top/',
         page_turning_number: 10,
         error_img: 'https://cravatar.cn/avatar/57d8260dfb55501c37dde588e7c3852c'
      })
      fc.load()
   </script>
</section>


    <!-- 页面说明 -->
    <div class="prose-wrapper">
      <Markdown class="prose"><Content /></Markdown>
    </div>
  </div>
</MainGridLayout>

<style is:global>
  /* ======  样式与之前完全一致  ====== */
  :root{
    --radius:16px;--blur:12px;--glass:rgba(255,255,255,.55);
    --glass-border:rgba(255,255,255,.3);--glow:0 0 12px rgba(0,0,0,.05);
    --text:#222;--text-secondary:#555;--primary:#0066ff;--primary-light:#5e9bff;
  }
  html.dark{
    --glass:rgba(30,30,30,.55);--glass-border:rgba(255,255,255,.08);
    --glow:0 0 16px rgba(0,0,0,.25);--text:#eee;--text-secondary:#aaa;
  }
  .friends-container{max-width:900px;margin:auto;padding:2rem 1rem;}
  .friends-grid{display:grid;gap:1.5rem;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));}
  .glass-card{
    background:var(--glass);backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));
    border:1px solid var(--glass-border);border-radius:var(--radius);box-shadow:var(--glow),0 4px 20px rgba(0,0,0,.05);
    padding:1.25rem 1.5rem;display:flex;flex-direction:column;gap:.75rem;transition:transform .25s,box-shadow .25s;
  }
  .glass-card:hover{transform:translateY(-4px);box-shadow:0 8px 30px rgba(0,0,0,.1),var(--glow);}
  .card-header{display:flex;gap:1rem;align-items:center;}
  .avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;transition:transform .4s;}
  .glass-card:hover .avatar{transform:rotate(12deg) scale(1.08);}
  .info{flex:1;min-width:0;}
  .title{font-size:1.1rem;font-weight:600;color:var(--text);text-decoration:none;letter-spacing:.2px;}
  .title:hover{color:var(--primary);}
  .desc{font-size:.875rem;color:var(--text-secondary);margin:.25rem 0 .5rem;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
  .capsules{display:flex;flex-wrap:wrap;gap:.35rem;}
  .capsule{font-size:.7rem;padding:.2rem .6rem;border-radius:999px;background:hsl(var(--h));color:#fff;box-shadow:0 2px 4px rgba(0,0,0,.08);}
  .timeline{border-left:2px solid var(--primary-light);padding-left:.75rem;margin-top:.25rem;}
  .timeline-item{display:flex;align-items:center;gap:.5rem;font-size:.8rem;color:var(--text-secondary);text-decoration:none;margin:.4rem 0;}
  .timeline-item time{flex-shrink:0;color:var(--primary);font-weight:500;}
  .timeline-item:hover span{color:var(--primary);}
  .timeline-item span{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .actions{display:flex;gap:.5rem;margin-top:auto;justify-content:flex-end;}
  .btn{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--glass);border:1px solid var(--glass-border);transition:transform .2s,background .2s;}
  .btn:hover{transform:scale(1.15);background:var(--primary-light);}
  .btn svg{width:18px;height:18px;fill:var(--text);}
  .btn:hover svg{fill:#fff;}
  .primary{background:var(--primary);border-color:var(--primary);}
  .primary svg{fill:#fff;}
  .prose-wrapper{margin-top:3rem;}
  .fc-section{margin-top:3rem;}
  #small-circle{font-size:1.25rem;font-weight:600;color:var(--text);margin-bottom:1rem;}
  #friend-circle-lite-root{color:var(--text);}
  html.dark #friend-circle-lite-root,
  html.dark #friend-circle-lite-root .fc-item,
  html.dark #friend-circle-lite-root .fc-name,
  html.dark #friend-circle-lite-root .fc-title,
  html.dark #friend-circle-lite-root .fc-excerpt,
  html.dark #friend-circle-lite-root .fc-read-more,
  html.dark #friend-circle-lite-root .fc-load-more,
  html.dark #friend-circle-lite-root .fc-time,
  html.dark #friend-circle-lite-root .fc-stats{color:#fff!important;}
</style>

<!-- 友链朋友圈：内联立即执行，第一次就能跑 -->
