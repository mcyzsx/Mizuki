---
/**
 * 60 秒读懂世界 – Markdown 版
 * 每次刷新实时拉取最新 Markdown 并美化渲染
 */
import MainGridLayout from "../layouts/MainGridLayout.astro";
---

<MainGridLayout title="60 秒读懂世界">
  <main class="max-w-3xl mx-auto px-4 py-8">
    <!-- 头部 -->
    <header class="mb-8 text-center">
      <h1 class="text-3xl font-extrabold text-slate-800 dark:text-slate-100">
        60 秒读懂世界
      </h1>
      <p id="subTitle" class="mt-2 text-sm text-slate-500 dark:text-slate-400">
        加载中…
      </p>
    </header>

    <!-- 新闻列表骨架屏 -->
    <section
      id="newsWrap"
      class="bg-white dark:bg-slate-800 rounded-2xl shadow-md p-6 mb-8"
    >
      <ul class="space-y-3">
        {Array(10)
          .fill(0)
          .map(() => (
            <li class="flex items-start gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-700/50">
              <span class="shrink-0 w-7 h-7 rounded-full bg-slate-200 dark:bg-slate-600" />
              <span class="h-5 flex-1 rounded bg-slate-200 dark:bg-slate-600" />
            </li>
          ))}
      </ul>
    </section>

    <!-- 每日一句骨架屏 -->
    <blockquote
      id="tipWrap"
      class="bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-900/30 dark:to-purple-900/30 rounded-2xl p-6 text-center italic text-slate-600 dark:text-slate-300"
    >
      加载中…
    </blockquote>
  </main>

  <!-- 客户端脚本 -->
  <script>
    /* 使用项目里已有的 markdown-it */
    import MarkdownIt from "markdown-it";
    const md = new MarkdownIt({ html: true, linkify: true, typographer: true });

    async function load60s() {
      const newsWrap = document.getElementById("newsWrap")!;
      const tipWrap  = document.getElementById("tipWrap")!;
      const subTitle = document.getElementById("subTitle")!;

      try {
        const res = await fetch("https://60s.kemeow.top/v2/60s?encoding=markdown");
        if (!res.ok) throw new Error("网络错误");
        const markdown = await res.text();

        /* 提取每日一句 > xxx */
        const tipMatch = markdown.match(/^>\s*(.+)$/m);
        const tip = tipMatch ? tipMatch[1].trim() : "愿每一天都温柔以待。";

        /* 去掉每日一句后剩余新闻主体 */
        const newsMd = markdown.replace(/^>\s*.+$/m, "").trim();

        /* Markdown -> HTML */
        const newsHtml = md.render(newsMd);

        /* 渲染 */
        subTitle.textContent = "刚刚";
        subTitle.className   = "mt-2 text-sm text-slate-500 dark:text-slate-100";

        newsWrap.innerHTML = `
          <article class="prose prose-slate dark:prose-invert max-w-none">
            ${newsHtml}
          </article>`;

        tipWrap.textContent = `“${tip}”`;
      } catch (e) {
        newsWrap.innerHTML = `<p class="text-center text-rose-600 dark:text-rose-400">加载失败，请刷新重试</p>`;
        tipWrap.textContent = "";
      }
    }

    load60s();
  </script>
</MainGridLayout>