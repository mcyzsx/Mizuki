---
/**
 * Weather page â€“ å›½å†…IPè‡ªåŠ¨å®šä½ / å›½å¤–IP fallback å—äº¬å¸‚
 */
import MainGridLayout from '../layouts/MainGridLayout.astro';

/* ---------- ç±»å‹ ---------- */
type IpResp = { code: number; message: string; data: { ip: string } };

type WeatherResp = {
  code: number;
  message: string;
  data: {
    location: {
      name: string;
      province: string;
      city: string;
      county: string;
    };
    weather: {
      condition: string;
      condition_code: string;
      temperature: number;
      humidity: number;
      pressure: number;
      precipitation: number;
      wind_direction: string;
      wind_power: string;
      weather_icon: string;
      weather_colors: string[];
      updated: string;
    };
    air_quality: {
      aqi: number;
      level: number;
      quality: string;
      pm25: number;
      pm10: number;
      co: number;
      no2: number;
      o3: number;
      so2: number;
      rank: number;
      total_cities: number;
      updated: string;
    };
    sunrise: {
      sunrise: string;
      sunrise_desc: string;
      sunset: string;
      sunset_desc: string;
    };
    life_indices: Array<{
      key: string;
      name: string;
      level: string;
      description: string;
    }>;
    alerts: any[];
  };
};

/* ---------- 1. å– IP ---------- */
const ipRes = await fetch('https://60s.kemeow.top/v2/ip');
if (!ipRes.ok) throw new Error(`ip fetch error: ${ipRes.status}`);
const ipJson = (await ipRes.json()) as IpResp;
const visitorIP = ipJson.data.ip;

/* ---------- 2. ç”¨ IP å–å¤©æ°” ---------- */
let weatherJson: WeatherResp;
let isFallback = false;
try {
  const wRes = await fetch(`https://60s.kemeow.top/v2/weather?query=${visitorIP}`);
  weatherJson = (await wRes.json()) as WeatherResp;
  if (weatherJson.code !== 200) throw new Error(weatherJson.message);
} catch {
  // å›½å¤– IP æˆ–ä»»ä½•å¼‚å¸¸ â†’ fallback å—äº¬
  isFallback = true;
  const njRes = await fetch('https://60s.kemeow.top/v2/weather?query=å—äº¬å¸‚');
  weatherJson = (await njRes.json()) as WeatherResp;
}

const { location, weather, air_quality, sunrise, life_indices, alerts } = weatherJson.data;

/* ---------- 3. Emoji æ˜ å°„ ---------- */
const conditionEmoji: Record<string, string> = {
  '01': 'â˜€ï¸',
  '02': 'â›…',
  '03': 'â˜ï¸',
  '04': 'ğŸŒ§ï¸',
  '05': 'â›ˆï¸',
  '06': 'ğŸŒ¨ï¸',
  '07': 'ğŸŒ«ï¸',
  '08': 'ğŸŒªï¸',
};
const emoji = conditionEmoji[weather.condition_code] ?? 'ğŸŒˆ';
---

<MainGridLayout title={`å¤©æ°” Â· ${location.city}`}>
  <!-- é¡¶éƒ¨å¡ç‰‡ -->
  <section
    class="card mb-6 flex flex-col gap-4 md:flex-row md:items-center text-black dark:text-white"
    style={`--bg-start:${weather.weather_colors[0]};--bg-mid:${weather.weather_colors[1]};--bg-end:${weather.weather_colors[2]}`}
  >
    <div class="text-7xl drop-shadow-lg">{emoji}</div>
    <div class="flex-1">
      <h1 class="text-2xl font-bold">
        {location.name} Â· {weather.condition}
      </h1>
      {isFallback && (
        <p class="text-sm text-red-500/90 dark:text-red-400/90">æœªæ”¶å®¹æ‚¨æ‰€åœ¨çš„åŸå¸‚ï¼Œå·²å±•ç¤ºå—äº¬å¤©æ°”</p>
      )}
      <p class="text-5xl font-black">{weather.temperature}Â°</p>
      <p class="text-sm opacity-80">
        æ¹¿åº¦ {weather.humidity}% Â· æ°”å‹ {weather.pressure}hPa Â· é™æ°´ {weather.precipitation}mm
      </p>
      <p class="text-sm opacity-80">
        {weather.wind_direction} {weather.wind_power} Â· æ›´æ–°äº {weather.updated}
      </p>
    </div>
  </section>

  <!-- ç©ºæ°”è´¨é‡ -->
  <section class="card mb-6 text-black dark:text-white">
    <h2 class="mb-3 text-xl font-semibold">ç©ºæ°”è´¨é‡</h2>
    <div class="grid gap-3 md:grid-cols-3">
      <div class="flex items-center justify-between">
        <span class="opacity-80">AQI</span>
        <span class="text-2xl font-bold">{air_quality.aqi}</span>
      </div>
      <div class="flex items-center justify-between">
        <span class="opacity-80">ç­‰çº§</span>
        <span class="text-2xl font-bold text-green-500">{air_quality.quality}</span>
      </div>
      <div class="flex items-center justify-between">
        <span class="opacity-80">PM2.5</span>
        <span class="text-2xl font-bold">{air_quality.pm25}</span>
      </div>
      <div class="flex items-center justify-between"><span class="opacity-80">PM10</span><span>{air_quality.pm10}</span></div>
      <div class="flex items-center justify-between"><span class="opacity-80">CO</span><span>{air_quality.co}</span></div>
      <div class="flex items-center justify-between"><span class="opacity-80">NOâ‚‚</span><span>{air_quality.no2}</span></div>
      <div class="flex items-center justify-between"><span class="opacity-80">Oâ‚ƒ</span><span>{air_quality.o3}</span></div>
      <div class="flex items-center justify-between"><span class="opacity-80">SOâ‚‚</span><span>{air_quality.so2}</span></div>
      <div class="col-span-full flex items-center justify-between text-sm opacity-70">
        å…¨å›½æ’å {air_quality.rank}/{air_quality.total_cities} åŸå¸‚ Â· æ›´æ–°äº {air_quality.updated}
      </div>
    </div>
  </section>

  <!-- æ—¥å‡ºæ—¥è½ -->
  <section class="card mb-6 text-black dark:text-white">
    <h2 class="mb-3 text-xl font-semibold">æ—¥å‡ºæ—¥è½</h2>
    <div class="grid gap-3 md:grid-cols-2">
      <div class="flex items-center justify-between">
        <span class="opacity-80">æ—¥å‡º</span>
        <span class="text-2xl font-bold">{sunrise.sunrise_desc}</span>
      </div>
      <div class="flex items-center justify-between">
        <span class="opacity-80">æ—¥è½</span>
        <span class="text-2xl font-bold">{sunrise.sunset_desc}</span>
      </div>
    </div>
  </section>

  <!-- ç”Ÿæ´»æŒ‡æ•° -->
  <section class="card mb-6 text-black dark:text-white">
    <h2 class="mb-3 text-xl font-semibold">ç”Ÿæ´»æŒ‡æ•°</h2>
    <ul class="grid gap-3 md:grid-cols-2">
      {life_indices.map((item) => (
        <li class="flex items-start justify-between">
          <div>
            <p class="font-semibold">{item.name}</p>
            <p class="text-sm opacity-70">{item.description}</p>
          </div>
          <span class="ml-4 shrink-0 rounded bg-sky-600/20 px-2 py-0.5 text-sm dark:bg-sky-400/20">
            {item.level}
          </span>
        </li>
      ))}
    </ul>
  </section>

  <!-- é¢„è­¦ -->
  {alerts && alerts.length > 0 && (
    <section class="card border-red-400 dark:border-red-600 text-black dark:text-white">
      <h2 class="mb-3 text-xl font-semibold text-red-500">æ°”è±¡é¢„è­¦</h2>
      <pre class="whitespace-pre-wrap text-sm">{JSON.stringify(alerts, null, 2)}</pre>
    </section>
  )}

  <!-- é¡µè„šæç¤º -->
  <p class="mt-6 text-center text-xs opacity-60 dark:text-white">
    æ•°æ®æ¥è‡ª <a class="underline" href="https://github.com/vikiboss/60s" target="_blank">60s å¼€æºæ¥å£</a>
    Â· æ›´æ–°äº {weather.updated}
  </p>
</MainGridLayout>

<style>
  .card {
    @apply rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-800;
    background-image: linear-gradient(135deg, var(--bg-start, transparent) 0%, var(--bg-mid, transparent) 50%, var(--bg-end, transparent) 100%);
  }
</style>