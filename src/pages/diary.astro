---
import MarkdownIt from 'markdown-it';
import { siteConfig } from '../config';
import I18nKey from '../i18n/i18nKey';
import { i18n } from '../i18n/translation';
import MainGridLayout from '../layouts/MainGridLayout.astro';

/* 1. è‹¥æ—¥è®°é¡µå…³é—­åˆ™ 404 */
if (!siteConfig.featurePages.diary) return Astro.redirect('/404/');

/* 2. æ‹‰å–è¿œç«¯æ•°æ® */
const API = 'https://cdn.jsdelivr.net/gh/mcyzsx/cdn-api@output/v2/repos/mcyzsx/Moment/issues%3Fper_page%3D20/data.json';
let remoteIssues: any[] = [];
try {
  const res = await fetch(API);
  if (res.ok) remoteIssues = await res.json();
} catch (e) {
  console.warn('[diary] fetch error:', e);
}

/* 3. Markdown æ¸²æŸ“å™¨ */
const md = new MarkdownIt({ html: true, linkify: true, typographer: true });

interface Moment {
  id: number;
  title: string;
  html: string;      // å·²æ¸²æŸ“çš„ markdown
  date: string;      // created_at
  labels: string[];  // æ ‡ç­¾
  images: string[];  // æå–çš„ img src
}
const moments: Moment[] = remoteIssues.map((issue) => {
  const html = md.render(issue.body || '');
  // æå–æ‰€æœ‰ img src
  const images = Array.from(html.matchAll(/<img[^>]+src="([^">]+)"/g)).map((m) => m[1]);
  return {
    id: issue.id,
    title: issue.title,
    html,
    date: issue.created_at,
    labels: (issue.labels || []).map((l: any) => l.name),
    images,
  };
});

/* 4. æ—¶é—´å·®æ ¼å¼åŒ– */
function formatTime(dateString: string): string {
  const now = new Date();
  const date = new Date(dateString);
  const diffInMinutes = Math.floor(
    (now.getTime() - now.getTimezoneOffset() * 60 * 1000 - date.getTime()) / (1000 * 60)
  );
  if (diffInMinutes < 60) return `${diffInMinutes}${i18n(I18nKey.diaryMinutesAgo)}`;
  if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}${i18n(I18nKey.diaryHoursAgo)}`;
  return `${Math.floor(diffInMinutes / 1440)}${i18n(I18nKey.diaryDaysAgo)}`;
}
---

<MainGridLayout title={i18n(I18nKey.diary)} description="å³åˆ»çŸ­æ–‡">
  <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
    <div class="card-base z-10 px-4 py-4 md:px-6 md:py-5 relative w-full">
      <div class="relative max-w-4xl">
        <!-- å¤´éƒ¨ -->
        <div class="moments-header mb-6">
          <div class="header-content">
            <div class="header-info">
              <h1 class="moments-title text-xl md:text-2xl lg:text-3xl font-bold text-90 mb-1">{i18n(I18nKey.diary)}</h1>
              <p class="moments-subtitle text-sm md:text-base lg:text-lg text-75">{i18n(I18nKey.diarySubtitle)}</p>
            </div>
            <div class="header-stats">
              <div class="stat-item text-center">
                <span class="stat-number text-lg md:text-xl lg:text-2xl font-bold text-[var(--primary)]">{moments.length}</span>
                <span class="stat-label text-xs md:text-sm lg:text-base text-75">{i18n(I18nKey.diaryCount)}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- æ—¶é—´çº¿ -->
        <div class="moments-timeline">
          <div class="timeline-list space-y-4">
            {moments.map((m) => (
              <div class="moment-item card-base p-4 md:p-6 lg:p-8 hover:shadow-lg transition-all">
                <div class="moment-content">
                  <h2 class="text-base md:text-lg font-semibold mb-2">{m.title}</h2>
                  <div
                    class="moment-text prose prose-sm md:prose-base max-w-none text-90 leading-relaxed mb-3 md:mb-4"
                    set:html={m.html}
                  />
                </div>

                <hr class="moment-divider border-t border-[var(--line-divider)] my-3 md:my-4" />

                <div class="moment-footer flex justify-between items-center">
                  <div class="moment-time flex items-center gap-1.5 text-75 text-xs md:text-sm lg:text-base">
                    <i class="time-icon text-xs md:text-sm">ğŸ•</i>
                    <time datetime={m.date}>{formatTime(m.date)}</time>
                  </div>
                  {m.labels.length > 0 && (
                    <div class="flex gap-2">
                      {m.labels.map((l) => (
                        <span class="text-xs px-2 py-0.5 rounded-full bg-[var(--primary-translucent)] text-[var(--primary)]">
                          {l}
                        </span>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>

        <!-- åº•éƒ¨æç¤º -->
        <div class="moments-tips text-center mt-6 md:mt-8 lg:mt-10 text-75 text-xs md:text-sm lg:text-base italic">
          {i18n(I18nKey.diaryTips)}
        </div>
      </div>
    </div>
  </div>
</MainGridLayout>

<!-- çº¯ CSS ç¯ç®± -->
<style>
  .lightbox {
    cursor: zoom-in;
  }
  input[type="checkbox"].lightbox-toggle {
    display: none;
  }
  .lightbox-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    z-index: 9999;
  }
  .lightbox-toggle:checked + .lightbox-overlay {
    opacity: 1;
    visibility: visible;
  }
  .lightbox-overlay img {
    max-width: 90vw;
    max-height: 90vh;
    border-radius: 8px;
  }
  .lightbox-close {
    position: absolute;
    top: 1rem;
    right: 1.5rem;
    color: #fff;
    font-size: 2rem;
    cursor: pointer;
  }
</style>

<script>
  document.querySelectorAll('.moment-text img').forEach((img: HTMLImageElement, idx) => {
    const src = img.src;
    const id = `lb-${Date.now()}-${idx}`;
    const wrapper = document.createElement('span');
    wrapper.innerHTML = `
      <label for="${id}" class="lightbox">
        <img src="${src}" alt="${img.alt}" loading="lazy" class="rounded-md" />
      </label>
      <input type="checkbox" id="${id}" class="lightbox-toggle" />
      <div class="lightbox-overlay">
        <label for="${id}" class="lightbox-close">&times;</label>
        <img src="${src}" alt="${img.alt}" />
      </div>
    `;
    img.replaceWith(wrapper);
  });
</script>

<style>
  /* --- åŸæœ‰å¡ç‰‡/å¤´éƒ¨/å“åº”å¼æ ·å¼å…¨éƒ¨ä¿ç•™ --- */
  .card-base {
    background: var(--card-bg);
    border: 1px solid var(--line-divider);
    transition: all 0.3s ease;
  }
  .moments-header {
    padding: 1rem;
    border-radius: 8px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark, var(--primary)) 100%);
    color: white;
    position: relative;
    overflow: hidden;
  }
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 1;
  }
  .moments-title {
    color: white;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }
  .moments-subtitle {
    color: rgba(255, 255, 255, 0.9);
  }
  .stat-number {
    color: white;
  }
  .stat-label {
    color: rgba(255, 255, 255, 0.8);
  }
  @media (max-width: 640px) {
    .moments-header {
      padding: 0.75rem;
    }
    .header-content {
      flex-direction: column;
      text-align: center;
      gap: 0.75rem;
    }
  }
</style>