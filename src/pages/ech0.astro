---
import MainGridLayout from "@/layouts/MainGridLayout.astro";
import BiliVideo from "@/components/BiliVideo.astro";
import GitHubRepoCard from "@/components/GitHubRepoCard.astro";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";

/* =================== ç±»å‹å®šä¹‰ =================== */
interface EchoImage {
  id: number;
  image_url: string;
  image_source: string;
  message_id: number;
}

interface EchoItem {
  id: number;
  content: string;
  username: string;
  private: boolean;
  user_id: number;
  fav_count: number;
  created_at: string;
  images?: EchoImage[];
  extension?: string;
  extension_type?: string;
  tags?: { name: string }[];
}

interface EchoResp {
  code: number;
  msg: string;
  data: { total: number; items: EchoItem[] };
}

/* =================== 1. æ‹‰å–æ•°æ® =================== */
const resp = await fetch("https://ech0.050815.xyz/api/echo/page");
const json = (await resp.json()) as EchoResp;
const items: EchoItem[] = json.data?.items ?? [];

/* =================== 2. æ—¶é—´æ ¼å¼åŒ– =================== */
function formatTime(dateString: string): string {
  const dt = new Date(dateString);
  const Y = dt.getFullYear();
  const M = String(dt.getMonth() + 1).padStart(2, "0");
  const D = String(dt.getDate()).padStart(2, "0");
  const h = String(dt.getHours()).padStart(2, "0");
  const m = String(dt.getMinutes()).padStart(2, "0");
  return `${Y}-${M}-${D} ${h}:${m}`;
}

/* =================== 3. æå–ç½‘æ˜“ song id =================== */
function getNeteaseSongId(url: string): string {
  const m = url.match(/[?&]id=(\d+)/);
  return m ? m[1] : "";
}

/* =================== 4. æ„é€ æ¸²æŸ“æ•°æ® =================== */
const moments = items.map((it) => ({
  id: it.id,
  content: it.content || "",
  date: it.created_at,
  images: it.images?.map((img) => img.image_url) ?? [],
  tags: it.tags?.map((t) => t.name) ?? [],
  extension: it.extension,
  extension_type: it.extension_type,
}));
---

<MainGridLayout title="ç¬é—´" description="ç”Ÿæ´»ç‚¹æ»´ç¢ç¢å¿µ">
  <div
    class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32"
  >
    <div class="card-base z-10 px-4 py-4 md:px-6 md:py-5 relative w-full">
      <div class="relative max-w-4xl">
        <!-- é¡µå¤´ -->
        <div class="moments-header mb-6">
          <div class="header-content">
            <div class="header-info">
              <h1 class="moments-title text-xl md:text-2xl lg:text-3xl font-bold mb-1 text-white">
                ç¬é—´
              </h1>
              <p class="moments-subtitle text-sm md:text-base lg:text-lg text-white/90">
                è®°å½•ç”Ÿæ´»ç‚¹æ»´ï¼Œä¸€äº›æƒ³æ³•
              </p>
            </div>
            <div class="header-stats">
              <div class="stat-item text-center">
                <span class="stat-number text-lg md:text-xl lg:text-2xl font-bold text-white">
                  {moments.length}
                </span>
                <span class="stat-label text-xs md:text-sm lg:text-base text-white/80">
                  {i18n(I18nKey.diaryCount)}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- è¯´è¯´åˆ—è¡¨ -->
        <div class="moments-timeline">
          <div class="timeline-list space-y-4">
            {moments.map((m) => (
              <div class="moment-item card-base p-4 md:p-6 lg:p-8 hover:shadow-lg transition-all">
                <div class="moment-content">
                  <p
                    class="moment-text text-sm md:text-base lg:text-lg text-90 leading-relaxed mb-3 md:mb-4"
                    set:html={m.content.replace(/\n/g, "<br />")}
                  />

                  {/* å›¾ç‰‡ */}
                  {m.images.length > 0 && (
                    <div class="moment-images grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 md:gap-3 lg:gap-4 mb-3 md:mb-4">
                      {m.images.map((src) => (
                        <div class="image-item relative rounded-md overflow-hidden aspect-square cursor-pointer hover:scale-105 transition-transform">
                          <img
                            src={src}
                            alt=""
                            class="w-full h-full object-cover"
                            loading="lazy"
                          />
                        </div>
                      ))}
                    </div>
                  )}

                  {/* éŸ³ä¹ â€”â€” NeteaseMiniPlayer */}
                  {m.extension_type === "MUSIC" && m.extension && (
                    <div class="mb-3 md:mb-4">
                      <div
                        class="netease-mini-player"
                        data-song-id={getNeteaseSongId(m.extension)}
                        data-lyric="true"
                        data-theme="auto"
                        data-size="compact"
                      />
                    </div>
                  )}

                  {/* B ç«™è§†é¢‘ */}
                  {m.extension_type === "VIDEO" && m.extension && (
                    <BiliVideo url={m.extension} />
                  )}

                  {/* GitHub å¡ç‰‡ */}
                  {m.extension_type === "GITHUBPROJ" && m.extension && (
                    <div class="mb-3 md:mb-4">
                      <GitHubRepoCard
                        repo={m.extension
                          .replace("https://github.com/", "")
                          .replace(/\/$/, "")}
                        url={m.extension}
                      />
                    </div>
                  )}
                </div>

                <hr class="moment-divider border-t border-[var(--line-divider)] my-3 md:my-4" />

                <div class="moment-footer flex justify-between items-center">
                  <div class="moment-time flex items-center gap-1.5 text-75 text-xs md:text-sm lg:text-base">
                    <i class="time-icon text-xs md:text-sm">ğŸ•</i>
                    <time datetime={m.date}>
                      {formatTime(m.date)}
                    </time>
                  </div>

                  {m.tags.length > 0 && (
                    <div class="text-xs text-[var(--primary)]">
                      ğŸ·ï¸ {m.tags.join(", ")}
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>

        <!-- åº•éƒ¨æç¤º -->
        <div class="moments-tips text-center mt-6 md:mt-8 lg:mt-10 text-75 text-xs md:text-sm lg:text-base italic">
          ä»…æ˜¾ç¤ºæœ€è¿‘ {items.length} æ¡è®°å½•
        </div>
      </div>
    </div>
  </div>
</MainGridLayout>

<!-- ==========  å¼•å…¥ NeteaseMiniPlayer  ========== -->
<link
  rel="stylesheet"
  href="/assets/css/netease-mini-player-v2.css"
/>
<script
  is:inline
  src="https://netease.zsx815.top/netease-mini-player-v2.js"
></script>

<style>
  /* ä¸åŸæ–‡ä»¶å®Œå…¨ä¸€è‡´ï¼Œç›´æ¥å¤ç”¨ */
  .card-base {
    background: var(--card-bg);
    border: 1px solid var(--line-divider);
    transition: all 0.3s ease;
  }
  .moments-header {
    padding: 1rem;
    border-radius: 8px;
    background: linear-gradient(135deg, #fb923c 0%, #ea580c 100%);
    color: #fff;
  }
  .moments-header .text-white {
    color: #ffffff !important;
  }
  .moments-header .text-gray-300 {
    color: #d1d5db !important;
  }
  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .moment-images .image-item img {
    transition: transform 0.3s;
  }
  .moment-images .image-item:hover img {
    transform: scale(1.05);
  }
  @media (max-width: 640px) {
    .header-content {
      flex-direction: column;
      text-align: center;
      gap: 0.75rem;
    }
    .moment-images {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>